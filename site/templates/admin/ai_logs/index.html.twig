{% extends 'base.html.twig' %}
{% block title %}AI Logs (last 50){% endblock %}

{% block body %}
    <h1 class="text-xl font-semibold mb-3">AI Logs — последние 50</h1>

    <form method="get" class="mb-4 flex gap-2">
        <input class="flex-1" name="feature" placeholder="feature (e.g. intent_classify)" value="{{ feature|default('') }}">
        <button class="px-3 py-1 bg-gray-900 text-white rounded">Фильтр</button>
    </form>

    <div class="overflow-x-auto bg-white border rounded">
        <table class="min-w-full text-sm">
            <thead class="bg-gray-50 border-b">
            <tr>
                <th class="p-2 text-left">Created</th>
                <th class="p-2 text-left">Company</th>
                <th class="p-2 text-left">Feature</th>
                <th class="p-2 text-left">Channel</th>
                <th class="p-2 text-left">Model</th>
                <th class="p-2 text-left">Status</th>
                <th class="p-2 text-left">Latency</th>
                <th class="p-2 text-left">Prompt</th>
                <th class="p-2 text-left">Response</th>
                <th class="p-2 text-left">Search (JSON)</th>
            </tr>
            </thead>
            <tbody>
            {% for r in logs %}
                <tr class="border-b align-top">
                    <td class="p-2 text-xs text-gray-600">{{ r.createdAt|date('Y-m-d H:i:s') }}</td>
                    <td class="p-2"><code class="text-xs">{{ r.company.id }}</code></td>
                    <td class="p-2"><span class="text-xs px-2 py-0.5 rounded bg-indigo-100 text-indigo-700">{{ r.feature }}</span></td>
                    <td class="p-2 text-xs">{{ r.channel }}</td>
                    <td class="p-2 text-xs">{{ r.model }}</td>
                    <td class="p-2">
                        {% if r.status.value == 'ok' %}
                            <span class="text-green-600 font-medium">OK</span>
                        {% else %}
                            <span class="text-red-600 font-medium">ERR</span>
                        {% endif %}
                    </td>
                    <td class="p-2 text-xs">{{ r.latencyMs }} ms</td>
                    <td class="p-2 w-1/2">
                        <pre class="text-xs whitespace-pre-wrap bg-gray-50 border rounded p-2">{{ r.prompt }}</pre>
                    </td>
                    <td class="p-2 w-1/2">
                        <pre class="text-xs whitespace-pre-wrap bg-gray-50 border rounded p-2">{{ r.response ?? '—' }}</pre>
                    </td>
                    <td class="p-2 w-1/2">
                        {% set search = r.metadata.search ?? {} %}
                        {% set searchBlock = {
                            'raw_query': search.raw_query is defined ? search.raw_query : null,
                            'norm_query': search.norm_query is defined ? search.norm_query : null,
                            'knowledge_hits': search.hits_count is defined ? search.hits_count : 0
                        } %}
                        <pre class="text-xs whitespace-pre-wrap bg-gray-50 border rounded p-2">{{ searchBlock|json_encode(constant('JSON_UNESCAPED_UNICODE') b-or constant('JSON_PRETTY_PRINT')) }}</pre>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="10" class="p-4 text-center text-gray-500">Нет записей.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
