Вот зафиксированная архитектура модуля **Account** в формате Markdown. Этот документ можно сохранить как `src/Account/README.md` внутри проекта для справочника команды.

---

# Модуль Account: Архитектура и Стандарты

## 1. Назначение

Модуль является **Identity & Tenant Core** системы. Он управляет жизненным циклом организации (Company), её пользователями (User) и состоянием лицевого счета/подписки (Billing).

## 2. Структура директорий (`src/Account/`)

| Директория | Ответственность |
| --- | --- |
| `Builder/` | **EntityBuilders** для генерации сложных объектов в тестах и фикстурах. |
| `Controller/` | Тонкие контроллеры: `Registration`, `Settings`, `Billing`. |
| `DTO/` | Объекты входных данных (например, `RegistrationRequest`). |
| `Entity/` | Доменные сущности (`User`, `Company`, `Subscription`). |
| `Form/` | Типы форм Symfony для обработки ввода. |
| `Repository/` | Логика выборки данных из БД (Doctrine). |
| `Service/` | **Use-cases**: `AccountManager`, `SubscriptionService`. |
| `Tests/` | Unit и Integration тесты модуля. |

---

## 3. Правила Сущностей (Entities)

### Жесткая связь (User <-> Company)

* **User** не может существовать без **Company**.
* Связь реализуется через обязательное поле в конструкторе `User`.
* При удалении `Company` срабатывает `cascade: remove` для всех связанных сущностей.

### Инкапсуляция

* Свойства сущностей `protected` или `private`.
* Бизнес-методы (например, `$user->promoteToOwner()`) предпочтительнее простых сеттеров.

---

## 4. Паттерн EntityBuilder

Используется для исключения хрупкости тестов. Вместо ручного наполнения объекта, используется текучий интерфейс (Fluent Interface).

**Пример использования:**

```php
$user = (new UserBuilder($company))
    ->withEmail('dev@gemini.ai')
    ->asAdmin()
    ->build();

```

---

## 5. Слой Сервисов (Business Logic)

* **AccountManager**: Единственная точка входа для создания/удаления аккаунта целиком.
* **SubscriptionService**: Инкапсулирует проверку лимитов (например, "может ли компания добавить еще одного оператора?").

---

## 6. Взаимодействие с другими модулями

* Другие модули (Chat, Marketplace) **не имеют права** напрямую менять данные в `src/Account/Entity`.
* Взаимодействие происходит только через вызов `AccountService` или чтение `UserInterface`.

---

## 7. Чек-лист проверки (Codex Compliance)

1. [ ] Код полностью изолирован в `src/Account/`.
2. [ ] Отсутствуют прямые SQL-запросы (только Repository).
3. [ ] Каждый новый Use-case покрыт Unit-тестом с использованием `EntityBuilder`.
4. [ ] Роутинг использует атрибуты с префиксом `#[Route('/account')]`.

---

**Зафиксировано.** Этот документ теперь является эталоном для разработки модуля.

**Следующий шаг:** Мне сгенерировать базовый код `User` и `Company` сущностей со всеми связями для этого модуля, или вы сначала покажете свои текущие наработки, чтобы я адаптировал их под этот стандарт?
