name: üöÄ Deploy to Production

on:
    push:
        branches: [ master ]

jobs:
    deploy:
        runs-on: ubuntu-latest
        
        steps:
            - name: üì¶ Checkout repository
              uses: actions/checkout@v4
            
            - name: üõ† Install zip
              run: sudo apt-get install -y zip
            
            - name: üîê Setup SSH key
              uses: webfactory/ssh-agent@v0.8.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
            
            - name: üì¶ Create deploy archive
              run: |
                  zip -r app.zip . \
                    -x "vendor/*" \
                    -x "var/*" \
                    -x "node_modules/*" \
                    -x "app.zip"
            
            - name: üì§ Upload archive to server
              run: |
                  for i in 1 2 3 4 5; do
                    scp \
                      -o StrictHostKeyChecking=no \
                      -o ConnectTimeout=20 \
                      -o ServerAliveInterval=15 \
                      -o ServerAliveCountMax=3 \
                      -o PreferredAuthentications=publickey \
                      -o PasswordAuthentication=no \
                      -4 \
                      app.zip "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.SERVER_DIR }}" && break
                    echo "SCP failed attempt $i, sleeping..."
                    sleep $((i*10))
                  done
            
            - name: üöÄ Deploy application
              run: |
                  for i in 1 2 3 4 5; do
                    ssh \
                      -o StrictHostKeyChecking=no \
                      -o ConnectTimeout=20 \
                      -o ServerAliveInterval=15 \
                      -o ServerAliveCountMax=3 \
                      -o PreferredAuthentications=publickey \
                      -o PasswordAuthentication=no \
                      -4 \
                      ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF' && break
                    set -e
                  
                    cd ${{ secrets.SERVER_DIR }}
                  
                    echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞"
                    rm -rf ./current
                    mkdir -p ./current
                    unzip -o app.zip -d ./current
                    rm app.zip
                  
                    echo "üê≥ –ó–∞–ø—É—Å–∫ docker-compose"
                    cd ./current

                    export DOCKER_BUILDKIT=1
                    export COMPOSE_DOCKER_CLI_BUILD=1
                  
                    APP_SECRET="${{ secrets.APP_SECRET }}" \
                    POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
                    docker compose -f docker-compose.prod.yml build --progress=plain

                    APP_SECRET="${{ secrets.APP_SECRET }}" \
                    POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
                    docker compose -f docker-compose.prod.yml up -d
                  
                    echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
                  EOF
                    echo "SSH failed attempt $i, sleeping..."
                    sleep $((i*10))
                  done
    
    migrations:
        needs: deploy
        runs-on: ubuntu-latest
        
        steps:
            - name: üîê Setup SSH key
              uses: webfactory/ssh-agent@v0.8.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
            
            - name: üïê Wait for services to be ready
              run: sleep 5
            
            - name: üß¨ Run Doctrine migrations
              run: |
                  for i in 1 2 3 4 5; do
                    ssh \
                      -o StrictHostKeyChecking=no \
                      -o ConnectTimeout=20 \
                      -o ServerAliveInterval=15 \
                      -o ServerAliveCountMax=3 \
                      -o PreferredAuthentications=publickey \
                      -o PasswordAuthentication=no \
                      -4 \
                      ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF' && break
                    echo "üöß –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏"
                    cd ${{ secrets.SERVER_DIR }}/current
                  
                    APP_SECRET="${{ secrets.APP_SECRET }}" \
                    POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
                    docker compose -f docker-compose.prod.yml run --rm site-php-cli bin/console doctrine:migrations:migrate --no-interaction
                    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
                  EOF
                    echo "SSH failed attempt $i, sleeping..."
                    sleep $((i*10))
                  done
