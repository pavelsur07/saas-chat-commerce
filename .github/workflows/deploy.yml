name: üöÄ Production CI/CD

on:
  push:
    branches: [ master ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ† Build and Push Images
        run: |
          # –°–±–æ—Ä–∫–∞ PHP-FPM
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/php-fpm:latest -f site/docker/production/php-fpm/Dockerfile site
          
          # –°–±–æ—Ä–∫–∞ PHP-CLI
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/php-cli:latest -f site/docker/production/php-cli/Dockerfile site
          
          # –°–±–æ—Ä–∫–∞ Nginx
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/nginx:latest -f site/docker/production/nginx/Dockerfile site
          
          # –°–±–æ—Ä–∫–∞ Socket Server (Node.js)
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/socket-server:latest socket-server

      - name: üöÄ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            # 1. –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd /srv/saas-chat/current
            
            # 2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Docker Compose
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
            export APP_SECRET="${{ secrets.APP_SECRET }}"
            
            # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–∏
            docker network inspect traefik-public >/dev/null 2>&1 || docker network create traefik-public

            echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤..."
            docker compose -f docker-compose.prod.yml pull
            
            echo "üèó –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã..."
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            
            echo "üîç –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã (5 —Å–µ–∫)..."
            sleep 5
            
            echo "üß¨ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π..."
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º run --rm –≤–º–µ—Å—Ç–æ exec, —Ç–∞–∫ –∫–∞–∫ php-cli —Å–µ—Ä–≤–∏—Å –Ω–µ –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–ø—É—â–µ–Ω–Ω—ã–º
            docker compose -f docker-compose.prod.yml run --rm -T site-php-cli bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration
            
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ Symfony..."
            docker compose -f docker-compose.prod.yml run --rm -T site-php-cli bin/console cache:clear --no-interaction
            
            echo "üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
            docker image prune -f
            
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"