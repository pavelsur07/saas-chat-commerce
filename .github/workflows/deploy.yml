name: üöÄ Production CI/CD

on:
  push:
    branches: [ master ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ† Build and Push Images
        run: |
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/php-fpm:latest -f site/docker/production/php-fpm/Dockerfile site
          
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/php-cli:latest -f site/docker/production/php-cli/Dockerfile site
          
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/nginx:latest -f site/docker/production/nginx/Dockerfile site
          
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/socket-server:latest socket-server

      - name: üöÄ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ —Ç–æ—á–Ω–æ–º—É –∞–¥—Ä–µ—Å—É, –∫–æ—Ç–æ—Ä—ã–π –º—ã –Ω–∞—à–ª–∏
            cd /srv/saas-chat/current
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $(pwd). –ü—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å!"
              exit 1
            fi

            # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
            export APP_SECRET="${{ secrets.APP_SECRET }}"
            
            # –°–æ–∑–¥–∞–µ–º —Å–µ—Ç—å, –µ—Å–ª–∏ –µ—ë –µ—â–µ –Ω–µ—Ç (—á—Ç–æ–±—ã –Ω–µ —É–ø–∞–ª–æ —Å –æ—à–∏–±–∫–æ–π external network)
            docker network inspect traefik-public >/dev/null 2>&1 || docker network create traefik-public

            echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤..."
            docker compose -f docker-compose.prod.yml pull
            
            echo "üèó –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã..."
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            
            echo "üîç –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏..."
            sleep 10
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ Nginx –ø–æ–¥–Ω—è–ª—Å—è
            if [ $(docker ps -f name=site-nginx -q | wc -l) -eq 0 ]; then
              echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–ø–∞–ª–∏! –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              docker compose -f docker-compose.prod.yml logs --tail=30
              exit 1
            fi
            
            echo "üß¨ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î..."
            docker compose -f docker-compose.prod.yml exec -T site-php-cli bin/console doctrine:migrations:migrate --no-interaction
            
            echo "üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–ª–æ–µ–≤ –æ–±—Ä–∞–∑–æ–≤..."
            docker image prune -f
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"