name: üöÄ Fast Deploy

on:
  push:
    branches: [ master ]

# –†–∞–∑—Ä–µ—à–∞–µ–º Actions –ø—É—à–∏—Ç—å –æ–±—Ä–∞–∑—ã –≤ –ø–∞–∫–µ—Ç—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ† Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/production/php/Dockerfile # –£–∫–∞–∂–∏ –ø—É—Ç—å –∫ —Å–≤–æ–µ–º—É Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/app:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üöÄ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.SERVER_DIR }}
            
            # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
            docker compose -f docker-compose.prod.yml pull
            
            APP_SECRET="${{ secrets.APP_SECRET }}" \
            POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
            docker compose -f docker-compose.prod.yml up -d
            
            # –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
            docker compose -f docker-compose.prod.yml run --rm site-php-cli bin/console doctrine:migrations:migrate --no-interaction
            
            # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤
            docker image prune -f