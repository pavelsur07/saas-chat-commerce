name: Deploy Production

on:
  push:
    branches:
      - master # –∏–ª–∏ main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # –ü–µ—Ä–µ–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ —Å–∫—Ä–∏–ø—Ç
          envs: APP_SECRET,POSTGRES_PASSWORD,GITHUB_REPOSITORY
          script: |
            set -e
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–∫—Ä–µ—Ç SERVER_DIR)
            cd ${{ secrets.SERVER_DIR }}
            
            echo "üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–∏..."
            docker network inspect traefik-public >/dev/null 2>&1 || docker network create traefik-public
            
            echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤..."
            docker compose -f docker-compose.prod.yml pull
            
            echo "üèó –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            # --wait –ø–æ–¥–æ–∂–¥–µ—Ç, –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å—Ç–∞–Ω—É—Ç healthy (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã healthchecks)
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            
            echo "üß¨ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π Symfony..."
            # –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —É–ø–∞–¥—É—Ç, set -e –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç —Å–∫—Ä–∏–ø—Ç –∏ –ø–æ–º–µ—Ç–∏—Ç –¥–µ–ø–ª–æ–π –∫–∞–∫ Failed
            docker compose -f docker-compose.prod.yml exec -T site-php-cli bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration
            
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
            docker image prune -f
            
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"

      - name: Post-deployment Check
        if: failure()
        run: |
          echo "‚ùå –î–µ–ø–ª–æ–π —É–ø–∞–ª. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤ –ø–∞–Ω–µ–ª–∏ GitHub Actions –≤—ã—à–µ."
          # –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å curl –∑–∞–ø—Ä–æ—Å –∫ –±–æ—Ç—É —Ç–µ–ª–µ–≥—Ä–∞–º–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ