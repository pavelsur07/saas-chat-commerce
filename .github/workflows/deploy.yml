name: üöÄ Production CI/CD

on:
  push:
    branches: [ master ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ† Build and Push Images
        run: |
          # –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∞ GitHub Actions
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/php-fpm:latest -f site/docker/production/php-fpm/Dockerfile site
          
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/php-cli:latest -f site/docker/production/php-cli/Dockerfile site
          
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/nginx:latest -f site/docker/production/nginx/Dockerfile site
          
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/socket-server:latest socket-server

      - name: üöÄ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.SERVER_DIR }}
            
            # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ shell
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
            export APP_SECRET="${{ secrets.APP_SECRET }}"
            export TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
            export TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
            
            echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤..."
            docker compose -f docker-compose.prod.yml pull
            
            echo "üèó –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            # --remove-orphans —É–¥–∞–ª–∏—Ç —Å—Ç–∞—Ä—ã–µ —Ö–≤–æ—Å—Ç—ã, –Ω–æ –ù–ï —Ç—Ä–æ–Ω–µ—Ç volumes
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–∂–¥–µ–º 10 —Å–µ–∫—É–Ω–¥)..."
            sleep 10
            docker ps
            
            # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ docker ps –ø—É—Å—Ç–æ–π –∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–ø–∞–ª–∏ ‚Äî –≤—ã–≤–æ–¥–∏–º –ª–æ–≥–∏ –∏ —Ñ–µ–π–ª–∏–º –±–∏–ª–¥
            if [ $(docker ps -f name=site-nginx -q | wc -l) -eq 0 ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –ø–æ–¥–Ω—è–ª–∏—Å—å! –í—ã–≤–æ–∂—É –ª–æ–≥–∏..."
              docker compose -f docker-compose.prod.yml logs
              exit 1
            fi
            
            echo "üß¨ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
            docker compose -f docker-compose.prod.yml exec -T site-php-cli bin/console doctrine:migrations:migrate --no-interaction
            
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
            docker image prune -f