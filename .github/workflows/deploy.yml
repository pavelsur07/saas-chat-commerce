name: üöÄ Production CI/CD

on:
  push:
    branches: [ master ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ† Build and Push Images
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º —Å—Ä–∞–∑—É –≤—Å–µ –æ–±—Ä–∞–∑—ã. –ö—ç—à (gha) —Å–¥–µ–ª–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –±–∏–ª–¥—ã –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º–∏.
          
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/php-fpm:latest -f site/docker/production/php-fpm/Dockerfile site
          
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/php-cli:latest -f site/docker/production/php-cli/Dockerfile site
          
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/nginx:latest -f site/docker/production/nginx/Dockerfile site
          
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/socket-server:latest socket-server

      - name: üöÄ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.SERVER_DIR }}
            
            # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GHCR –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # –£–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –¥–ª—è docker-compose (–Ω—É–∂–Ω–æ –¥–ª—è –ø—É—Ç–µ–π –∫ –æ–±—Ä–∞–∑–∞–º)
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
            export APP_SECRET="${{ secrets.APP_SECRET }}"
            export TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
            export TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑—ã –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            
            # –ú–∏–≥—Ä–∞—Ü–∏–∏
            echo "üß¨ Running migrations..."
            docker compose -f docker-compose.prod.yml exec -T site-php-cli bin/console doctrine:migrations:migrate --no-interaction
            
            # –û—á–∏—Å—Ç–∫–∞ –º–µ—Å—Ç–∞
            docker image prune -f