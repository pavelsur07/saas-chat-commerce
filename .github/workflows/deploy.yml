name: üöÄ Production CI/CD

on:
  push:
    branches: [ master ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üõ† Build and Push Images
        run: |
          # –°–±–æ—Ä–∫–∞ PHP-FPM
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/php-fpm:latest -f site/docker/production/php-fpm/Dockerfile site
          
          # –°–±–æ—Ä–∫–∞ PHP-CLI
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/php-cli:latest -f site/docker/production/php-cli/Dockerfile site
          
          # –°–±–æ—Ä–∫–∞ Nginx
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/nginx:latest -f site/docker/production/nginx/Dockerfile site
          
          # –°–±–æ—Ä–∫–∞ Socket Server (Node.js)
          docker buildx build --cache-from type=gha --cache-to type=gha,mode=max --push \
            -t ghcr.io/${{ github.repository }}/socket-server:latest socket-server

      - name: üöÄ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            # 1. –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd /srv/saas-chat/current
            
            # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–Ω—Ñ–∏–≥–∞
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo "‚ùå –§–∞–π–ª docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $(pwd)"
              exit 1
            fi

            # 3. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 4. –ü—Ä–æ–±—Ä–æ—Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
            export APP_SECRET="${{ secrets.APP_SECRET }}"
            
            # 5. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ç–∏
            docker network inspect traefik-public >/dev/null 2>&1 || docker network create traefik-public

            echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤..."
            docker compose -f docker-compose.prod.yml pull
            
            echo "üèó –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã..."
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            
            echo "üîç –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ (10 —Å–µ–∫)..."
            sleep 10
            
            # 6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ (–Ω–∞—à —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
            if [ $(docker ps -f name=site-nginx -q | wc -l) -eq 0 ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–ø–∞–ª–∏ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞!"
              echo "üìã –ü–û–°–õ–ï–î–ù–ò–ï –õ–û–ì–ò –î–õ–Ø –û–¢–õ–ê–î–ö–ò:"
              docker compose -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi
            
            echo "üß¨ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π..."
            docker compose -f docker-compose.prod.yml exec -T site-php-cli bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration
            
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."
            docker image prune -f
            
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"